<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rivgraph.directionality &mdash; RivGraph 0.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/rg_logo_full.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../background/index.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maskmaking/index.html">Maskmaking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shoreline/index.html">Shoreline creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linksnodes/index.html">Link and Node Dictionaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../issues/index.html">Known issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../featuredevelopment/index.html">Feature Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gallery/index.html">RivGraph in the wild</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apiref/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">RivGraph</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">rivgraph.directionality</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rivgraph.directionality</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Directionality Utilities (directionality.py)</span>
<span class="sd">============================================</span>

<span class="sd">Created on Wed Nov  7 11:38:16 2018</span>
<span class="sd">@author: Jon</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">mode</span>
<span class="kn">from</span> <span class="nn">rivgraph</span> <span class="kn">import</span> <span class="n">ln_utils</span> <span class="k">as</span> <span class="n">lnu</span>
<span class="kn">from</span> <span class="nn">rivgraph</span> <span class="kn">import</span> <span class="n">io_utils</span> <span class="k">as</span> <span class="n">io</span>


<div class="viewcode-block" id="add_directionality_trackers"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.add_directionality_trackers">[docs]</a><span class="k">def</span> <span class="nf">add_directionality_trackers</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">ntype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds fields to the links and nodes dictionaries that are required for</span>
<span class="sd">    setting and diagnosing directionality. Nodes are not altered in this</span>
<span class="sd">    function, but passed for consistency and generalizability.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    ntype : str</span>
<span class="sd">        Network type. Choose either &#39;delta&#39; or &#39;river&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links with added directionality properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Add a &#39;certain&#39; entry to the links dict to keep track of links whose directions have been set</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>  <span class="c1"># tracks whether a link&#39;s directinoality is certain or not</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>  <span class="c1"># tracks the order in which links certainty is set</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>  <span class="c1"># tracks the algorithm used to set certainty</span>

    <span class="c1"># Add a &quot;guess&quot; entry to keep track of the different algorithms&#39; guesses for flow directionality</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))]</span>  <span class="c1"># contains guess at upstream ndoe</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))]</span>  <span class="c1"># contains algorithm that made guess</span>

    <span class="c1"># Add network-type-specific properties</span>
    <span class="k">if</span> <span class="n">ntype</span> <span class="o">==</span> <span class="s1">&#39;river&#39;</span><span class="p">:</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;maxang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># saves the angle used in set_by_flow_directions, diagnostic only</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="algmap"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.algmap">[docs]</a><span class="k">def</span> <span class="nf">algmap</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a numeric key corresponding to each algorithm used by RivGraph to</span>
<span class="sd">    set link directionality. These numbers are found in links[&#39;guess_alg&#39;] and</span>
<span class="sd">    links[&#39;certain_alg&#39;] and are useful for diagnosing issues in setting</span>
<span class="sd">    directionality.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : str</span>
<span class="sd">        See the mapper below for the possible keywords.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    algno : float or int</span>
<span class="sd">        Numeric representation of direction-setting algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mapper</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sourcesinkfix&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
              <span class="s1">&#39;manual_set&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
              <span class="s1">&#39;inletoutlet&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
              <span class="s1">&#39;continuity&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="s1">&#39;parallels&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="s1">&#39;artificials&#39;</span> <span class="p">:</span> <span class="mf">2.1</span><span class="p">,</span>
              <span class="s1">&#39;main_chans&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
              <span class="s1">&#39;bridges&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
              <span class="s1">&#39;known_fdr&#39;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
              <span class="s1">&#39;known_fdr_rs&#39;</span> <span class="p">:</span> <span class="mf">6.1</span><span class="p">,</span>
              <span class="s1">&#39;syn_dem&#39;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
              <span class="s1">&#39;syn_dem_med&#39;</span> <span class="p">:</span> <span class="mf">10.1</span><span class="p">,</span>
              <span class="s1">&#39;sym_dem_leftover&#39;</span> <span class="p">:</span> <span class="mf">10.2</span><span class="p">,</span>
              <span class="s1">&#39;sp_links&#39;</span> <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
              <span class="s1">&#39;sp_nodes&#39;</span> <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
              <span class="s1">&#39;longest_steepest&#39;</span> <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
              <span class="s1">&#39;three_agree&#39;</span> <span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
              <span class="s1">&#39;syn_dem_and_sp&#39;</span> <span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
              <span class="s1">&#39;cl_dist_guess&#39;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
              <span class="s1">&#39;cl_ang_guess&#39;</span> <span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
              <span class="s1">&#39;cl_dist_set&#39;</span> <span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
              <span class="s1">&#39;cl_ang_set&#39;</span> <span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
              <span class="s1">&#39;cl_ang_rs&#39;</span> <span class="p">:</span> <span class="mf">23.1</span><span class="p">,</span>
              <span class="s1">&#39;cl_dist_and_ang&#39;</span> <span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
              <span class="s1">&#39;short_no_bktrck&#39;</span> <span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
              <span class="s1">&#39;wid_pctdiff&#39;</span> <span class="p">:</span> <span class="mi">26</span><span class="p">}</span>

    <span class="n">algno</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">algno</span></div>


<div class="viewcode-block" id="set_by_nearest_main_channel"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.set_by_nearest_main_channel">[docs]</a><span class="k">def</span> <span class="nf">set_by_nearest_main_channel</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span> <span class="n">nodethresh</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets all possible links&#39; directions using the nearest main channel. The</span>
<span class="sd">    main channels are found as the widest, shortest paths from each inlet to</span>
<span class="sd">    each outlet. For each unknown link, the distance is computed from its</span>
<span class="sd">    endpoints to the nearest nodes of the nearest main channel. If the nearest</span>
<span class="sd">    nodes of the main channel include more than 2 + nodethresh nodes, the</span>
<span class="sd">    direction of the main channel is used to set the unknown link.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    imshape : tuple</span>
<span class="sd">        Shape of binary mask as (nrows, ncols).</span>
<span class="sd">    nodethresh : int, optional</span>
<span class="sd">        Threshold for the number of nodes along the nearest main channel that</span>
<span class="sd">        must be encompassed by the unknown link&#39;s endnodes to confidently</span>
<span class="sd">        set the unknown link&#39;s direction. The default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># alg = 3 # identifier for diagnostics</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;parallels&#39;</span><span class="p">)</span>

    <span class="c1"># Find widest inlet node</span>
    <span class="n">inlet_idx</span> <span class="o">=</span> <span class="n">widest_inlet_index</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="c1"># More weight given to longer and narrower channels</span>
    <span class="n">Aweight</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_adj&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_adj&#39;</span><span class="p">])</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">Aweight</span> <span class="o">*</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span>

    <span class="c1"># Create networkX graph, adding weighted edges</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">wt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">wt</span><span class="p">)</span>

    <span class="c1"># Get all paths from inlet(s) to outlets</span>
    <span class="n">all_pathnodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">inl</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>
            <span class="n">all_pathnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">][</span><span class="n">inlet_idx</span><span class="p">],</span> <span class="n">o</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">))</span>

    <span class="c1"># Reduce all pathnodes to smallest set, saving associated path for each node</span>
    <span class="n">pathnode_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ap</span> <span class="ow">in</span> <span class="n">all_pathnodes</span><span class="p">:</span>
        <span class="n">pathnode_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span>
    <span class="n">pathnode_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathnode_set</span><span class="p">)</span>
    <span class="n">belongs_to</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathnode_set</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pathnode_set</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ap</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pathnodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ap</span><span class="p">:</span>
                <span class="n">belongs_to</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

    <span class="c1"># Get node coordinates of all path nodes</span>
    <span class="n">pathnode_set_idcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">pathnode_set</span><span class="p">]</span>
    <span class="n">rc_pathnodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">pathnode_set_idcs</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>

    <span class="c1"># Find the nearest path to all uncertain links</span>
    <span class="n">uncertains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">uncertains</span><span class="p">:</span>

        <span class="c1"># Since we&#39;re not updating uncertains as links are being set, need to</span>
        <span class="c1"># recheck that the link hasn&#39;t been set by continuity/aritifical node</span>
        <span class="c1"># due to setting a previous uncertain link</span>
        <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">u</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Find nearest path to each centerline endpoint</span>
        <span class="n">nconn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">u</span><span class="p">]</span>
        <span class="n">nidxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nconn</span><span class="p">]</span>
        <span class="n">lrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">nidxs</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>

        <span class="n">nearest_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lrc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">nearest_pathnode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span><span class="o">-</span><span class="n">rc_pathnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="n">rc_pathnodes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">nearest_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">belongs_to</span><span class="p">[</span><span class="n">nearest_pathnode</span><span class="p">])</span>

        <span class="c1"># Choose any path that is nearest to both nodes</span>
        <span class="n">closest_to_link</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nearest_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nearest_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">closest_to_link</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># The links&#39;s endpoints are closer to two different paths</span>
            <span class="k">continue</span>

        <span class="n">use_path</span> <span class="o">=</span> <span class="n">closest_to_link</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="c1"># Now that path to compare against is known, determine the flow direction</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">all_pathnodes</span><span class="p">[</span><span class="n">use_path</span><span class="p">]</span>
        <span class="n">path_rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">([</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">path</span><span class="p">],</span> <span class="n">imshape</span><span class="p">)</span>

        <span class="c1"># Closest index of each end node of link:</span>
        <span class="n">nearest_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lrc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">nearest_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span><span class="o">-</span><span class="n">path_rc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="n">path_rc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># If threshold is surpassed, set link</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nearest_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">nearest_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">nodethresh</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">nearest_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nearest_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">nconn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nearest_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nearest_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">nconn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="nodepath_to_links"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.nodepath_to_links">[docs]</a><span class="k">def</span> <span class="nf">nodepath_to_links</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a path defined by node ids to a path defined by link ids.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : list</span>
<span class="sd">        Node ids comprising a path within the network.</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    linkpath : list</span>
<span class="sd">        Link ids comprising the path defined by the given node ids.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">linkpath</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">ulinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span>
        <span class="n">vlinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
        <span class="n">linkpath</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ul</span> <span class="k">for</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">ulinks</span> <span class="k">if</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">vlinks</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">linkpath</span></div>


<div class="viewcode-block" id="widest_inlet_index"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.widest_inlet_index">[docs]</a><span class="k">def</span> <span class="nf">widest_inlet_index</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the index of the inlet occurring at the widest link. Index is with</span>
<span class="sd">    respect to the nodes[&#39;id&#39;] list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inlet_idx : int</span>
<span class="sd">        Index of the inlet node of the widest link.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Find apex node, assuming it&#39;s connected to the widest channel(s)</span>
    <span class="n">inletW</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]:</span>
        <span class="n">nidx</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="n">lids</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nidx</span><span class="p">]</span>
        <span class="n">inletW</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_adj&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">li</span><span class="p">)]</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">]))</span>

    <span class="n">W</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">inletW</span><span class="p">)</span>
    <span class="n">inlet_idx</span> <span class="o">=</span> <span class="n">inletW</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inlet_idx</span></div>


<div class="viewcode-block" id="dir_main_channel"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.dir_main_channel">[docs]</a><span class="k">def</span> <span class="nf">dir_main_channel</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Guesses directionality of links based on shortest paths from widest inlet</span>
<span class="sd">    link to all the outlet links. Links are also weighted by width, such that</span>
<span class="sd">    deviations from the &quot;main channel&quot; width cost more to traverse.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># alg = 4 # identifier for diagnostics</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;main_chans&#39;</span><span class="p">)</span>

    <span class="n">inlet_idx</span> <span class="o">=</span> <span class="n">widest_inlet_index</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="c1"># More weight given to longer and narrower channels</span>
    <span class="n">Aweight</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_adj&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_adj&#39;</span><span class="p">])</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">Aweight</span> <span class="o">*</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span>

    <span class="c1"># Create networkX graph, adding weighted edges</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">wt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">wt</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>

        <span class="n">pathnodes</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">][</span><span class="n">inlet_idx</span><span class="p">],</span> <span class="n">o</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>
        <span class="n">pathlinks</span> <span class="o">=</span> <span class="n">nodepath_to_links</span><span class="p">(</span><span class="n">pathnodes</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Set the directionality of each of the links</span>
        <span class="k">for</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">pl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pathnodes</span><span class="p">,</span> <span class="n">pathlinks</span><span class="p">):</span>

            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>

            <span class="c1"># Don&#39;t set if already set</span>
            <span class="k">if</span> <span class="n">alg</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Store guess</span>
                <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">usnode</span><span class="p">)</span>
                <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="dir_shortest_paths_nodes"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.dir_shortest_paths_nodes">[docs]</a><span class="k">def</span> <span class="nf">dir_shortest_paths_nodes</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Guesses link directionality based on the shortest path from its end</span>
<span class="sd">    nodes to the nearest outlet (or pre-outlet). For each unknown link, if the</span>
<span class="sd">    path flows through the link attached to the node (as opposed to immediately</span>
<span class="sd">    away from the link), its directionality is set; otherwise nothing</span>
<span class="sd">    is done. Note that this will not set all links&#39; directionalities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># alg = 12 # identifier for diagnostics</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;sp_nodes&#39;</span><span class="p">)</span>

    <span class="c1"># Create networkX graph, adding weighted edges</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">wt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]):</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">wt</span><span class="p">)</span>

    <span class="c1"># Get all &quot;pre-outlet&quot;, i.e. nodes one link upstream of outlets. Use these so that decision of where to chop off outlet links doesn&#39;t play a role in shortest path.</span>
    <span class="n">preoutlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>
        <span class="n">linkconn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">o</span><span class="p">)][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">othernode</span> <span class="o">=</span> <span class="n">linkconn</span><span class="p">[:]</span>
        <span class="n">othernode</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">preoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">othernode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># All shortest paths</span>
    <span class="n">msdpl</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">multi_source_dijkstra_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">preoutlets</span><span class="p">)</span>

    <span class="c1"># Loop through all nodes; the directionality of the first link</span>
    <span class="c1"># flowed through to reach the nearest outlet (or preoutlet) node is set</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">nidx</span><span class="p">,</span> <span class="n">nconn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">]):</span>

        <span class="k">if</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">preoutlets</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Get the shortest path from nid to the nearest outlet or preoutlet</span>
        <span class="n">shortpath</span> <span class="o">=</span> <span class="n">msdpl</span><span class="p">[</span><span class="n">nid</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Set first link of the shortest path</span>
        <span class="c1"># Find the link first</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">posslink</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nconn</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">posslink</span><span class="p">)])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">shortpath</span><span class="p">[:</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">linkid</span> <span class="o">=</span> <span class="n">nconn</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>

        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">linkid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">alg</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]:</span>
            <span class="c1"># If the guess agrees with previously guessed for this algorithm, move on</span>
            <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">alg</span><span class="p">)]</span> <span class="o">==</span> <span class="n">nid</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Update certainty</span>
            <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="dir_shortest_paths_links"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.dir_shortest_paths_links">[docs]</a><span class="k">def</span> <span class="nf">dir_shortest_paths_links</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">difthresh</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Guesses a link&#39;s directionality by which of its endpoint nodes is</span>
<span class="sd">    closer to the nearest outlet (or preoutlet). &quot;difthresh&quot; refers to the</span>
<span class="sd">    difference in distances between endpoint nodes; higher means directionality</span>
<span class="sd">    is less likely to be ascertained.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    difthresh : int, optional</span>
<span class="sd">        Threshold for the length (in number of nodes) that must be surpassed</span>
<span class="sd">        between an unknown link&#39;s endpoints for directionality to be set.</span>
<span class="sd">        Lengths are measured from the link&#39;s endpoints to the nearest</span>
<span class="sd">        outlet (or preoutlet). The default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># alg = 11 # identifier for diagnostics</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;sp_links&#39;</span><span class="p">)</span>

    <span class="c1"># Create networkX graph, adding weighted edges</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">wt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]):</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">wt</span><span class="p">)</span>

    <span class="c1"># Get all &quot;pre-outlet&quot;, i.e. nodes one link upstream of outlets. Use these so that decision of where to chop off outlet links doesn&#39;t play a role in shortest path.</span>
    <span class="n">preoutlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>
        <span class="n">linkconn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">o</span><span class="p">)][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">othernode</span> <span class="o">=</span> <span class="n">linkconn</span><span class="p">[:]</span>
        <span class="n">othernode</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">preoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">othernode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># NetworkX&#39;s multi-source dijkstra path length iterator</span>
    <span class="n">msdpl</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">multi_source_dijkstra_path_length</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">preoutlets</span><span class="p">)</span>

    <span class="c1"># METHOD 2: Direction ascertained based on the nearness of a link&#39;s endnodes</span>
    <span class="c1"># to the nearest outlet [closer is downstream]</span>
    <span class="k">for</span> <span class="n">il</span><span class="p">,</span><span class="n">lid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]):</span>

        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">lconn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][:]</span>

        <span class="c1"># Compute shortest distance from each end node to nearest pre-outlet</span>
        <span class="n">node_min_len</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">endnode</span> <span class="ow">in</span> <span class="n">lconn</span><span class="p">:</span>
            <span class="n">node_min_len</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msdpl</span><span class="p">[</span><span class="n">endnode</span><span class="p">])</span>

        <span class="c1"># Skip if the minima are too similar</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node_min_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_min_len</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">difthresh</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># DS node is the closer one</span>
            <span class="n">dsnode</span> <span class="o">=</span> <span class="n">lconn</span><span class="p">[</span><span class="n">node_min_len</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">node_min_len</span><span class="p">))]</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lconn</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">dsnode</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Update certainty</span>
            <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">usnode</span><span class="p">)</span>
            <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="dir_known_link_angles"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.dir_known_link_angles">[docs]</a><span class="k">def</span> <span class="nf">dir_known_link_angles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">checklinks</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Guesses directionality for unknown links whose immediately adjacent links&#39;</span>
<span class="sd">    directionalities are known. Computes the angle of &quot;flow&quot; between outlet and</span>
<span class="sd">    inlet end nodes for each neighboring link, then sets the unknown link</span>
<span class="sd">    such that its orientation minimizes the error between its neighbors and</span>
<span class="sd">    itself.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    dims : tuple</span>
<span class="sd">        Shape of the input mask as (nrows, ncols).</span>
<span class="sd">    checklinks : list OR str, optional</span>
<span class="sd">        A list of link ids can be provided to check only specific links.</span>
<span class="sd">        Otherwise, the default is &#39;all&#39; which checks all links.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">angle_between</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the angle in degrees between vectors v1 and v2. Angle is computed</span>
<span class="sd">        in the clockwise direction from v1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ang1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="n">v1</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ang2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="n">v2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">((</span><span class="n">ang1</span> <span class="o">-</span> <span class="n">ang2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="c1"># alg = 10 # identifier for diagnostics</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">checklinks</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">checklinks</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="n">linkangs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">checklinks</span><span class="p">:</span>
        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span>
        <span class="n">lidcs</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span>

        <span class="c1"># Ensure that all the directionalities of links connected to this one are known</span>
        <span class="n">connlinks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">linkconn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)][:]</span>
            <span class="n">linkconn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
            <span class="n">connlinks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">linkconn</span><span class="p">)</span>

        <span class="n">certs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">connlinks</span><span class="p">:</span>
            <span class="n">certs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cl</span><span class="p">)])</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">certs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">certs</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Coordinates of unknown link</span>
        <span class="n">rc_idcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">lidcs</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>

        <span class="c1"># Get angles of all connected links (oriented up-to-downstream)</span>
        <span class="n">angs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">horiz_vec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">connlinks</span><span class="p">:</span>
            <span class="n">linkidxt</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">lidcst</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">linkidxt</span><span class="p">]</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">lidcst</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
            <span class="c1"># Vector is downstream node minus upstream node</span>
            <span class="n">ep_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">angs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle_between</span><span class="p">(</span><span class="n">ep_vec</span><span class="p">,</span> <span class="n">horiz_vec</span><span class="p">))</span>

        <span class="c1"># Compute angle for both orientations of unknown link</span>
        <span class="n">poss_angs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">orient</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">orient</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ep_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc_idcs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rc_idcs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rc_idcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rc_idcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ep_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc_idcs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">rc_idcs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rc_idcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rc_idcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">poss_angs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle_between</span><span class="p">(</span><span class="n">ep_vec</span><span class="p">,</span> <span class="n">horiz_vec</span><span class="p">))</span>

        <span class="c1"># Compute the error</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pa</span><span class="o">-</span><span class="n">angs</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">poss_angs</span><span class="p">]</span>

        <span class="c1"># Choose orientation with smallest error</span>
        <span class="n">usnode</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">err</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">err</span><span class="p">))]</span>

        <span class="n">linkangs</span><span class="p">[</span><span class="n">linkidx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">usnode</span><span class="p">)</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="dir_bridges"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.dir_bridges">[docs]</a><span class="k">def</span> <span class="nf">dir_bridges</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Guesses directionality of bridge links. Bridge links are those which flow</span>
<span class="sd">    must pass through to reach the outlet; in other words, if a bridge link is</span>
<span class="sd">    removed from the network, there will no longer be just one connected</span>
<span class="sd">    network. Directionality is inferred by consideration of which subnetwork</span>
<span class="sd">    (after removing the bridge link) contains inlet and outlet nodes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># alg = 5 # identifier for diagnostic</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;bridges&#39;</span><span class="p">)</span>

    <span class="c1"># Create networkX graph object</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]):</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>

    <span class="c1"># Find bridge links; we don&#39;t want to count inlet and outlet links</span>
    <span class="n">preoutlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>
        <span class="n">linkconn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">o</span><span class="p">)][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">othernode</span> <span class="o">=</span> <span class="n">linkconn</span><span class="p">[:]</span>
        <span class="n">othernode</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">preoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">othernode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">bridges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">bridges</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
    <span class="n">bridgenodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">endnodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bridges</span><span class="p">:</span>
        <span class="n">bset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">endnodes</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">bridgenodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="n">bridgelinks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">bridgenodes</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bn</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)]:</span>
                <span class="n">bridgelinks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="c1"># Guess the bridge link</span>
    <span class="k">for</span> <span class="n">bl</span><span class="p">,</span> <span class="n">bn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bridgelinks</span><span class="p">,</span> <span class="n">bridgenodes</span><span class="p">):</span>
        <span class="c1"># Remove edge from graph</span>
        <span class="n">G</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">bn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bn</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># See which bridgenode connects to upstream node(s) -</span>
        <span class="c1"># Must account for possibility of multiple inlets, so must check both nodes</span>
        <span class="n">bn0_up</span><span class="p">,</span> <span class="n">bn0_down</span><span class="p">,</span> <span class="n">bn1_up</span><span class="p">,</span> <span class="n">bn1_down</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">has_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">bn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">bn0_down</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">has_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">bn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">bn1_down</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">has_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">bn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">bn0_up</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">has_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">bn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">bn1_up</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># There are rare cases where the bridge link cannot be set (if both sides of the bridge have an inlet and outlet)</span>
        <span class="c1"># In these cases, do nothing.</span>
        <span class="k">if</span> <span class="n">bn0_down</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">bn1_up</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">bn0_up</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">bn1_down</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Add the edge back to graph</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">bn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bn</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># Skip</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">bn0_down</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">bn1_up</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">bn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">bn0_up</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">bn1_down</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">bn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">blidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bl</span><span class="p">)</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">blidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">blidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">usnode</span><span class="p">)</span>

        <span class="c1"># Add the edge back to graph</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">bn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bn</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="cycle_get_original_orientation"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.cycle_get_original_orientation">[docs]</a><span class="k">def</span> <span class="nf">cycle_get_original_orientation</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">lids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the orientation of a set of links. Used before attempting to fix</span>
<span class="sd">    cycles. Properties besides &#39;conn&#39; must also be reversed, so their original</span>
<span class="sd">    orientations are also stored.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    lids : list</span>
<span class="sd">        Link ids whose orientations should be saved.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    orig : dict</span>
<span class="sd">        A subset of the links dictionary containing the orientations of each</span>
<span class="sd">        link in lids.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lidx</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">]</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lids</span>
    <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">l</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lidx</span><span class="p">]</span>
    <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">l</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lidx</span><span class="p">]</span>
    <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;wid_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_pix&#39;</span><span class="p">][</span><span class="n">l</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lidx</span><span class="p">]</span>
    <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lidx</span><span class="p">]</span>
    <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;certain_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_order&#39;</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lidx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">orig</span></div>


<div class="viewcode-block" id="cycle_return_to_original_orientation"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.cycle_return_to_original_orientation">[docs]</a><span class="k">def</span> <span class="nf">cycle_return_to_original_orientation</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">orig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a set of links to its original orientation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    orig : dict</span>
<span class="sd">        Network links and associated properties to return to original</span>
<span class="sd">        orientations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties in their original orientations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orig</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]):</span>
        <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:]</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:]</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_pix&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;wid_pix&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:]</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_order&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span><span class="s1">&#39;certain_order&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">links</span></div>


<div class="viewcode-block" id="merge_list_of_lists"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.merge_list_of_lists">[docs]</a><span class="k">def</span> <span class="nf">merge_list_of_lists</span><span class="p">(</span><span class="n">inlist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges a list of lists into a single list, but removes duplicates.</span>
<span class="sd">    Uses networkx and itertools for a fun solution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inlist : list of lists</span>
<span class="sd">        List of lists to merge without dulplicates.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    merged : list</span>
<span class="sd">        List of length equal to number of unique entries across all lists of</span>
<span class="sd">        inlist.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Combine overlapping cycles (where cycles share the same nodes, join them)</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations_with_replacement</span><span class="p">,</span> <span class="n">chain</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

    <span class="n">edges</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">combinations_with_replacement</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">inlist</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">merged</span></div>


<div class="viewcode-block" id="set_link"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.set_link">[docs]</a><span class="k">def</span> <span class="nf">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="mi">9999</span><span class="p">,</span> <span class="n">checkcontinuity</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets a link directionality. Option to check for continuity (including</span>
<span class="sd">    parallel links) after setting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    linkidx : int</span>
<span class="sd">        Index of link within links[&#39;id&#39;] to set. This index can be found from</span>
<span class="sd">        the link id via links[&#39;id&#39;].index(linkid).</span>
<span class="sd">    usnode : int</span>
<span class="sd">        Node id of the upstream node.</span>
<span class="sd">    alg : int, optional</span>
<span class="sd">        The algorithm id used to set the link. Used for diagnostic purposes and</span>
<span class="sd">        fixing cycles. The default is 9999.</span>
<span class="sd">    checkcontinuity : bool, optional</span>
<span class="sd">        If True, checks nearby links for continuity and parallel links after</span>
<span class="sd">        setting the link&#39;s direction. The default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties with updated link direction.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties with updated link direction.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">usnode</span><span class="p">)</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">usnode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">usnode</span><span class="p">)]:</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;wid_pix&#39;</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_pix&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_pix&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">alg</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_order&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_order&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">checkcontinuity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Set any other possible links via continuity</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">checknodes</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][:])</span>

        <span class="c1"># Also set parallel links connected to this one, or if this link is part</span>
        <span class="c1"># of a parallel set, set the others in the set</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_parallel_links</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">knownlink</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="fix_sources_and_sinks"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.fix_sources_and_sinks">[docs]</a><span class="k">def</span> <span class="nf">fix_sources_and_sinks</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixes sources and sinks within the network by flipping link directionality</span>
<span class="sd">    near the problem node(s). The links to flip are chosen by ensuring they do</span>
<span class="sd">    not create a cycle; if multiple links can be flipped, the shortest one is</span>
<span class="sd">    chosen. If no solution is found, links are returned to their original</span>
<span class="sd">    orientation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties with sources/sinks fixed if</span>
<span class="sd">        possible.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network links and associated properties with sources/sinks fixed if</span>
<span class="sd">        possible.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">badnodes</span> <span class="o">=</span> <span class="n">check_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">badnodes</span><span class="p">:</span>

        <span class="n">linkidx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">n_bn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">))</span>

        <span class="c1"># Get all the connected links</span>
        <span class="n">lconn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bn</span><span class="p">)]</span>

        <span class="c1"># Reverse their order and see if we&#39;ve violated continuity or created a cycle</span>
        <span class="n">bn_linkflip</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># number of bad nodes after flipping link</span>
        <span class="n">cycle_linkflip</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lconn</span><span class="p">:</span>
            <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">lnu</span><span class="o">.</span><span class="n">flip_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

            <span class="c1"># See if we&#39;ve violated continuity after flipping the link</span>
            <span class="n">badnodes_temp</span> <span class="o">=</span> <span class="n">check_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
            <span class="n">bn_linkflip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">badnodes_temp</span><span class="p">))</span>

            <span class="c1"># See if we&#39;ve created a cycle after flipping the link</span>
            <span class="n">endnodes</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][:]</span>
            <span class="n">c_nodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">endnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">c_nodes2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">endnodes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">c_nodes</span> <span class="ow">or</span> <span class="n">c_nodes2</span><span class="p">:</span>
                <span class="n">cycle_linkflip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cycle_linkflip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Re-flip links to original position</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">lnu</span><span class="o">.</span><span class="n">flip_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

        <span class="c1"># Now check if any of the flipped links solves the bad nodes AND doesn&#39;t</span>
        <span class="c1"># create a cycle--use that orientation if so</span>
        <span class="n">poss_bn</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">bnlf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lconn</span><span class="p">,</span> <span class="n">bn_linkflip</span><span class="p">)</span> <span class="k">if</span> <span class="n">bnlf</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">n_bn</span><span class="p">]</span>
        <span class="n">poss_cy</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lconn</span><span class="p">,</span> <span class="n">cycle_linkflip</span><span class="p">)</span> <span class="k">if</span> <span class="n">clf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">poss_links</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">poss_bn</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">poss_cy</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">poss_links</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># No possible links to flip, move on</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">poss_links</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Only one possible link we can flip, so do it</span>
            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">poss_links</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># More than one link meets the criteria; choose the shortest</span>
            <span class="n">linklens</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">poss_links</span><span class="p">]</span>
            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">poss_links</span><span class="p">[</span><span class="n">linklens</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">linklens</span><span class="p">))])</span>

        <span class="k">if</span> <span class="n">linkidx</span><span class="p">:</span>
            <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">alg</span><span class="o">=</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;sourcesinkfix&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="check_continuity"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.check_continuity">[docs]</a><span class="k">def</span> <span class="nf">check_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds all sinks or sources within the network, excluding inlets and outlets.</span>
<span class="sd">    Returns any nodes where continuity is violated. Only checks nodes for whom</span>
<span class="sd">    all attached links are certain.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    problem_nodes : list</span>
<span class="sd">        Node ids corresponding to nodes[&#39;id&#39;] where continuity is violated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">problem_nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">nidx</span><span class="p">,</span> <span class="n">nconn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">]):</span>

        <span class="k">if</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="n">certains</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)]</span> <span class="k">for</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">nconn</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">certains</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nconn</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">firstidx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lastidx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">linkid</span> <span class="ow">in</span> <span class="n">nconn</span><span class="p">:</span>
            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">linkid</span><span class="p">)</span>
            <span class="n">firstidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">lastidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">firstidx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">firstidx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">problem_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lastidx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">lastidx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">problem_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">problem_nodes</span></div>


<div class="viewcode-block" id="find_a_cycle"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.find_a_cycle">[docs]</a><span class="k">def</span> <span class="nf">find_a_cycle</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds a single cycle in the network. Multiple cycles may exist; this</span>
<span class="sd">    function returns only the first one encountered.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cycle_nodes : list</span>
<span class="sd">        Node ids comprising the cycle. Arranged in order of cycle.</span>
<span class="sd">    cycle_links : list</span>
<span class="sd">        Link ids comprising the cycle. Arranged in order of cycle.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">]:</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">cycle_nodes</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">find_cycle</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

    <span class="n">us</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cycle_nodes</span><span class="p">]</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cycle_nodes</span><span class="p">]</span>
    <span class="n">cycle_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">vs</span><span class="p">):</span>
            <span class="n">ulinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span>
            <span class="n">vlinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
            <span class="n">cycle_links</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ul</span> <span class="k">for</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">ulinks</span> <span class="k">if</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">vlinks</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">cycle_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cycle_nodes</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cycle_nodes</span><span class="p">,</span> <span class="n">cycle_links</span></div>


<div class="viewcode-block" id="get_cycles"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.get_cycles">[docs]</a><span class="k">def</span> <span class="nf">get_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">checknode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds either all cycles in the network or cycles containing the checknode&#39;th</span>
<span class="sd">    node. Cycles are returned as both nodes and links.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    checknode : int OR str, optional</span>
<span class="sd">        ID of node to check for its inclusion in any cycles. If the default</span>
<span class="sd">        value &#39;all&#39; is selected, all cycles will be returned.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cycle_nodes : list of lists</span>
<span class="sd">        List containing lists of all cycles found in the network; cycles are</span>
<span class="sd">        returned in cyclic order and in terms of node ids.</span>
<span class="sd">    cycles_links : TYPE</span>
<span class="sd">        List containing lists of all cycles found in the network; cycles are</span>
<span class="sd">        returned in cyclic order and in terms of link ids.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">]:</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">checknode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">cycle_nodes</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">simple_cycles</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
        <span class="c1"># Unpack the iterator</span>
        <span class="n">cycle_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cycle_nodes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">single_cycle</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">find_cycle</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">checknode</span><span class="p">)</span>
            <span class="n">single_cycle</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">single_cycle</span><span class="p">)</span>
            <span class="n">cycle_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">single_cycle</span><span class="p">:</span>
                <span class="n">cycle_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cycle_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">cycle_nodes</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">cycle_nodes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get links of cycles</span>
    <span class="n">cycles_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">cycle_nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cycle_nodes</span><span class="p">:</span>
            <span class="n">pathlinks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">us</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                <span class="n">ulinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">us</span><span class="p">)]</span>
                <span class="n">vlinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vs</span><span class="p">)]</span>
                <span class="n">pathlinks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ul</span> <span class="k">for</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">ulinks</span> <span class="k">if</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">vlinks</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cycles_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pathlinks</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cycles_links</span> <span class="o">=</span> <span class="n">cycle_nodes</span>

    <span class="k">return</span> <span class="n">cycle_nodes</span><span class="p">,</span> <span class="n">cycles_links</span></div>


<div class="viewcode-block" id="flip_links_in_G"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.flip_links_in_G">[docs]</a><span class="k">def</span> <span class="nf">flip_links_in_G</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">links2flip</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flips the directionality of links in a networkx graph object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    G : networkx.Graph or similar</span>
<span class="sd">        Graph object representing the network.</span>
<span class="sd">    links2flip : tuple or</span>
<span class="sd">        An Nx2 tuple containing the US and DS node ids of the edge (link) to</span>
<span class="sd">        flip.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    G : networkx.Graph or similar</span>
<span class="sd">        Graph object representing the network with the requested links flipped.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">links2flip</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">links2flip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">links2flip</span><span class="p">:</span>
        <span class="c1"># Remove the link</span>
        <span class="n">G</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">lf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Add it, but reversed</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">G</span></div>


<div class="viewcode-block" id="fix_cycles"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.fix_cycles">[docs]</a><span class="k">def</span> <span class="nf">fix_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempts to remove all cycles in the directed graph. A number of approaches</span>
<span class="sd">    are tried, and if any of them result in a source/sink node or a cycle,</span>
<span class="sd">    another approach is attempted until the cycle is resolved or we run out</span>
<span class="sd">    of approaches.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties with all possible cycles</span>
<span class="sd">        resolved.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties with all possible cycles</span>
<span class="sd">        resolved</span>
<span class="sd">    n_cycles_remaining : int</span>
<span class="sd">        Number of cycles that were unresolvable.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create networkx graph object</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">]:</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Check for cycles</span>
    <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_directed_acyclic_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># Get list of cycles to fix</span>
        <span class="n">c_nodes</span><span class="p">,</span> <span class="n">c_links</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Remove any cycles that are subsets of larger cycles</span>
        <span class="n">isin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">c_links</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">isin</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">icn</span><span class="p">,</span> <span class="n">cn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_nodes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">icn2</span><span class="p">,</span> <span class="n">cn2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_nodes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cn2</span> <span class="o">==</span> <span class="n">cn</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">cn2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">isin</span><span class="p">[</span><span class="n">icn</span><span class="p">]</span> <span class="o">=</span> <span class="n">icn2</span>
                    <span class="k">break</span>
        <span class="n">cfix_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">cn</span> <span class="k">for</span> <span class="n">icn</span><span class="p">,</span> <span class="n">cn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_nodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">isin</span><span class="p">[</span><span class="n">icn</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">cfix_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl</span> <span class="k">for</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_links</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">isin</span><span class="p">[</span><span class="n">icl</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># Fix all the cycles</span>
        <span class="k">for</span> <span class="n">cycle_n</span><span class="p">,</span> <span class="n">cycle_l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cfix_nodes</span><span class="p">,</span> <span class="n">cfix_links</span><span class="p">):</span>

            <span class="c1"># We will try every combination of flow directions and check each</span>
            <span class="c1"># combination for continuity violation and cycles, subsetting possibilities</span>
            <span class="c1"># to only those configurations that don&#39;t violate either.</span>

            <span class="c1"># First, subset our network to make computations faster; put subset</span>
            <span class="c1"># into networkX graph</span>
            <span class="n">acl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">cycle_n</span><span class="p">:</span>
                <span class="n">acl</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nid</span><span class="p">)])</span>
            <span class="n">all_cycle_links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">acl</span><span class="p">)</span>
            <span class="n">acn</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">all_cycle_links</span><span class="p">:</span>
                <span class="n">acn</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)])</span>
            <span class="n">all_cycle_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">acn</span><span class="p">)</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">all_cycle_nodes</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">all_cycle_links</span><span class="p">:</span>
                <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
                <span class="n">lc</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Determine our &quot;inlet&quot; and &quot;outlet&quot; links/nodes - these we will not flip</span>
            <span class="n">dangle_nodes</span> <span class="o">=</span> <span class="n">all_cycle_nodes</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">cycle_n</span><span class="p">)</span>
            <span class="n">dangle_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">all_cycle_links</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)])</span> <span class="o">-</span> <span class="n">dangle_nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ins_l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">outs_l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ins_n</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">outs_n</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">dangle_links</span><span class="p">:</span>
                <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>
                <span class="n">lconn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span>
                <span class="n">dn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lconn</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dangle_nodes</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dn</span> <span class="o">==</span> <span class="n">lconn</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">ins_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>
                    <span class="n">ins_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outs_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>
                    <span class="n">outs_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>

            <span class="c1"># Try all configurations of links and count the number of cycles/continuity violations (don&#39;t change dangle links)</span>
            <span class="c1"># First, find all combinations</span>
            <span class="n">fliplinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_cycle_links</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dangle_links</span><span class="p">))</span>
            <span class="n">all_combos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fliplinks</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">fliplinks</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
                    <span class="n">all_combos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

            <span class="c1"># If a cycle is too big, there will be too many combinations to</span>
            <span class="c1"># feasibly check all possibilities on a single processor. For now,</span>
            <span class="c1"># we just skip these and report them so they can be manually</span>
            <span class="c1"># corrected.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_combos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The cycle links </span><span class="si">{}</span><span class="s1"> is too large to attempt to fix automatically.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycle_l</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Iterate through each combination and determine violations: there are four conditions that must be met:</span>
            <span class="c1"># 1) no cycles,</span>
            <span class="c1"># 2) no sources/sinks</span>
            <span class="c1"># 3) all inlets must be able to drain to an outlet, and all outlets must be reachable from at least one inlet (inlets and outlets refer to those of the subset, not the entire graph)</span>
            <span class="c1"># 4) links cannot flow in opposition to manually set directions</span>
            <span class="n">cont_violators</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">len_cycle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">has_path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">manually_set</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">flink</span> <span class="ow">in</span> <span class="n">all_combos</span><span class="p">:</span>

                <span class="c1"># Flip all the links in flink</span>
                <span class="n">links2flip</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">flink</span><span class="p">:</span>
                    <span class="n">links2flip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">fl</span><span class="p">)][:])</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">flip_links_in_G</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">links2flip</span><span class="p">)</span>

                <span class="c1"># Check if a cycle exists</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cycles_temp</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">find_cycle</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
                    <span class="n">len_cycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles_temp</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">len_cycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Check if continuity is violated</span>
                <span class="n">sink_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">outdegree</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">out_degree</span><span class="p">)</span> <span class="k">if</span> <span class="n">outdegree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">dangle_nodes</span>
                <span class="n">source_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">indegree</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">in_degree</span><span class="p">)</span> <span class="k">if</span> <span class="n">indegree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">dangle_nodes</span>
                <span class="n">cont_violators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sink_nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_nodes</span><span class="p">))</span>

                <span class="c1"># Check if each inflow can reach an outflow and each outflow is reached by an inflow</span>
                <span class="n">hp_ins</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ins_n</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">outs_n</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">has_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">oo</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">hp_ins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="c1"># Flip links to test outlets</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">flip_links_in_G</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">links2flip</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="n">hp_outs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">outs_n</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ins_n</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">has_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">hp_outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="c1"># Flip em back</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">flip_links_in_G</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">links2flip</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

                <span class="c1"># Assign a &quot;1&quot; where inlet/outlet criteria are met</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hp_ins</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">outs_n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hp_outs</span><span class="p">):</span>
                    <span class="n">has_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">has_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Check that we&#39;re not flipping any links that have been set manually</span>
                <span class="n">set_by_alg</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">flink</span><span class="p">:</span>
                    <span class="n">set_by_alg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">fl</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;manual_set&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">set_by_alg</span><span class="p">:</span>
                    <span class="n">manually_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">manually_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Flip links back to original</span>
                <span class="n">links2flipback</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">flink</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">fl</span><span class="p">)][:]</span>
                    <span class="n">links2flipback</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">flip_links_in_G</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">links2flipback</span><span class="p">)</span>

            <span class="c1"># Find configurations that don&#39;t violate continuity and have no cycles</span>
            <span class="n">poss_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cont_violators</span><span class="p">,</span> <span class="n">len_cycle</span><span class="p">,</span> <span class="n">has_path</span><span class="p">,</span> <span class="n">manually_set</span><span class="p">))</span> <span class="k">if</span> <span class="n">nv</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">hp</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">poss_configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unfixable cycle found at links: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycle_l</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Choose the configuration that flips the fewest links</span>
            <span class="n">pc_lens</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">all_combos</span><span class="p">[</span><span class="n">pc</span><span class="p">])</span> <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">poss_configs</span><span class="p">]</span>
            <span class="n">links_to_flip</span> <span class="o">=</span> <span class="n">all_combos</span><span class="p">[</span><span class="n">poss_configs</span><span class="p">[</span><span class="n">pc_lens</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pc_lens</span><span class="p">))]]</span>

            <span class="c1"># Flip the links to fix the cycle</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links_to_flip</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">lnu</span><span class="o">.</span><span class="n">flip_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

    <span class="c1"># Check if any cycles remain</span>
    <span class="n">c_nodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_cycles_remaining</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_cycles_remaining</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_nodes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">n_cycles_remaining</span></div>


<div class="viewcode-block" id="dir_set_manually"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.dir_set_manually">[docs]</a><span class="k">def</span> <span class="nf">dir_set_manually</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">manual_set_csv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets link directions based on a user-provided csv-file. The csv file has</span>
<span class="sd">    exactly two columns; one called &#39;link_id&#39;, and one called &#39;usnode&#39;.</span>
<span class="sd">    This file can be created automatically by the function</span>
<span class="sd">    io_utils.create_manual_dir_csv().</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    manual_set_csv : str</span>
<span class="sd">        Path to csv defining which links have which upstream nodes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties with specified links set</span>
<span class="sd">        manually.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties with specified links set</span>
<span class="sd">        manually.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># alg = -1</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;manual_set&#39;</span><span class="p">)</span>

    <span class="c1"># Read the csv file for fixing link directions.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">manual_set_csv</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No file found for manually setting link directions.&#39;</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">create_manual_dir_csv</span><span class="p">(</span><span class="n">manual_set_csv</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;A .csv file for manual fixes to link directions at </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">manual_set_csv</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">{}</span><span class="s1"> to manually set flow directions.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">manual_set_csv</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">manual_set_csv</span><span class="p">)</span>

    <span class="c1"># Check if any links have been manually corrected and correct them</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">usnodes</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;usnode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">links_to_set</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;link_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">usn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links_to_set</span><span class="p">,</span> <span class="n">usnodes</span><span class="p">):</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">),</span> <span class="n">usn</span><span class="p">,</span>
                                    <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="set_inletoutlet"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.set_inletoutlet">[docs]</a><span class="k">def</span> <span class="nf">set_inletoutlet</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets directions of links that are connected to inlets and outlets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># alg = 0</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;inletoutlet&#39;</span><span class="p">)</span>

    <span class="c1"># Set directionality of inlet links</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]:</span>

        <span class="c1"># Get links attached to inlets</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="c1"># Set link directionality</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span>
                                    <span class="n">checkcontinuity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set directionality of outlet links</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>

        <span class="c1"># Get links attached to outlets</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">o</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="c1"># Set link directionality</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][:]</span>
            <span class="n">usnode</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span>
                                    <span class="n">checkcontinuity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="set_continuity"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.set_continuity">[docs]</a><span class="k">def</span> <span class="nf">set_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">checknodes</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets link directions by enforce continuity at each node such that there</span>
<span class="sd">    are no sources or sinks within the network. Iterates until no more links</span>
<span class="sd">    directions can be set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    checknodes : list OR str, optional</span>
<span class="sd">        Each link connected to each node id in this list will be checked for</span>
<span class="sd">        continuity. All nodes will be checked if using the default value &#39;all&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># alg = 1</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;continuity&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">checknodes</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">checknodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][:]</span>

    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">checknodes</span><span class="p">:</span>
        <span class="n">nindex</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="n">nidx</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nindex</span><span class="p">]</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nindex</span><span class="p">]</span>

        <span class="c1"># Initialize bookkeeping for all the links connected to this node</span>
        <span class="n">linkdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># 0 if uncertain, 1 if into, 2 if out of</span>

        <span class="k">if</span> <span class="n">linkdir</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Populate linkdir</span>
        <span class="k">for</span> <span class="n">il</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
            <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>

            <span class="c1"># Determine if link is flowing into node or out of node</span>
            <span class="c1"># Skip if we&#39;re uncertain about the link&#39;s direction</span>
            <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nidx</span><span class="p">:</span>  <span class="c1"># out of</span>
                <span class="n">linkdir</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="k">elif</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nidx</span><span class="p">:</span>  <span class="c1"># into</span>
                <span class="n">linkdir</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">linkdir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># If there is only a single unknown link</span>
            <span class="n">unknown_link_id</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">linkdir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">unknown_link_idx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">unknown_link_id</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">linkdir</span><span class="p">[</span><span class="n">linkdir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">lconn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">unknown_link_idx</span><span class="p">][:]</span>

            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">linkdir</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># if the non-zero elements are all the same (either all 1s or 2s)</span>

                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># The unknown link must be out of the node</span>
                    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">unknown_link_idx</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">m</span><span class="o">.</span><span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># The unknown link must be into the node</span>
                    <span class="n">usnode</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lconn</span> <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">nid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">unknown_link_idx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="set_parallel_links"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.set_parallel_links">[docs]</a><span class="k">def</span> <span class="nf">set_parallel_links</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">knownlink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets directionality of parallel links. If two links are parallel, they</span>
<span class="sd">    share the same end nodes. If the direction of one of the links is known,</span>
<span class="sd">    the other must be set in a direction to avoide creating a cycle within</span>
<span class="sd">    the graph. This function thus prevents cycles from being created and in</span>
<span class="sd">    general should be run after any link direction is set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    knownlink : int</span>
<span class="sd">        Link id of link whose direction has been set to check for parallel</span>
<span class="sd">        links.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># alg = 2</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;parallels&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;parallels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span>
    <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">knownlink</span><span class="p">)</span>
    <span class="n">docheck</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">parpairs</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;parallels&#39;</span><span class="p">]:</span>
        <span class="n">docheck</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Determine the upstream and downstream nodes for the parallel set.</span>
        <span class="k">if</span> <span class="n">knownlink</span> <span class="ow">in</span> <span class="n">parpairs</span><span class="p">:</span>  <span class="c1"># If the knownlink is part of the set</span>
            <span class="n">dsnode</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If the knownlink is not part of the set</span>
            <span class="n">dsnode</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Check if any parallel sets are connected to the known link</span>
        <span class="n">ppnodes</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parpairs</span><span class="p">[</span><span class="mi">0</span><span class="p">])][:]</span>
        <span class="k">for</span> <span class="n">parlink</span> <span class="ow">in</span> <span class="n">parpairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parlink</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dsnode</span> <span class="ow">in</span> <span class="n">ppnodes</span><span class="p">:</span>
                    <span class="n">usnode_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ppnodes</span> <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">dsnode</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parlink</span><span class="p">),</span> <span class="n">usnode_set</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span> <span class="n">checkcontinuity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">docheck</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">usnode</span> <span class="ow">in</span> <span class="n">ppnodes</span><span class="p">:</span>
                    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parlink</span><span class="p">),</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span> <span class="n">checkcontinuity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">docheck</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">docheck</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">checknodes</span><span class="o">=</span><span class="n">ppnodes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="get_link_vector"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.get_link_vector">[docs]</a><span class="k">def</span> <span class="nf">get_link_vector</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkid</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span> <span class="n">pixlen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">trim</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the normalized vector of a link that indicates the direction of</span>
<span class="sd">    flow through a link based on its connectivity. This function will first trim</span>
<span class="sd">    the link by its endpoint (half)width values to mitigate cases where where wide</span>
<span class="sd">    channels are connected to narrow channels.</span>

<span class="sd">    Requires a link contain at least min_len_for_trim pixels post-trimming.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    linkid : int</span>
<span class="sd">        ID of the link correspoinding to those found in links[&#39;id&#39;].</span>
<span class="sd">    imshape : tuple</span>
<span class="sd">        Shape of the binary mask as (nrows, ncols).</span>
<span class="sd">    pixlen : float, optional</span>
<span class="sd">        Length resolution of each pixel. The default is 1.</span>
<span class="sd">    normalized : bool, optional</span>
<span class="sd">        If True, will return a vector on [-1, 1]. The default is True.</span>
<span class="sd">    trim : bool, optional</span>
<span class="sd">        If True, links will be trimmed to remove possibly direction-biasing</span>
<span class="sd">        end segments. If False, the untrimmed link endpoints will define the</span>
<span class="sd">        vector direction. The default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    link_vec : np.array</span>
<span class="sd">        Two-element array describing the x and y components of the direction</span>
<span class="sd">        vector describing the link.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">min_len_for_trim</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># number of pixels remaining after trim to use trimmed version; else defaults to using endpoints</span>

    <span class="c1"># Get pixel coordinates of link</span>
    <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">linkid</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">],</span> <span class="n">imshape</span><span class="p">)</span>

    <span class="c1"># Try to trim the link if desired and possible</span>
    <span class="k">if</span> <span class="n">trim</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="s1">&#39;wid_pix&#39;</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="c1"># Get the half-widths at the endpoints</span>
        <span class="n">ep_wids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_pix&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">pixlen</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># Get the cumulative length of the link (forwards and reversed)</span>
        <span class="n">s_for</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">s_for</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">s_for</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">s_rev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">s_rev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">s_rev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Find the index along the link corresponding to each width&#39;s endpoint</span>
        <span class="n">f_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s_for</span> <span class="o">&gt;</span> <span class="n">ep_wids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">r_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s_rev</span> <span class="o">&gt;</span> <span class="n">ep_wids</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Trim both ends if possible</span>
        <span class="k">if</span> <span class="n">f_idx</span> <span class="o">&lt;</span> <span class="n">r_idx</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r_idx</span> <span class="o">-</span> <span class="n">f_idx</span> <span class="o">&gt;=</span> <span class="n">min_len_for_trim</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">f_idx</span><span class="p">:</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">f_idx</span><span class="p">:</span><span class="n">r_idx</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">f_idx</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">r_idx</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">r_idx</span> <span class="o">&gt;=</span> <span class="n">min_len_for_trim</span><span class="p">:</span>  <span class="c1"># Trim only the beginning</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">f_idx</span><span class="p">:],</span> <span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">f_idx</span><span class="p">:]]</span>
            <span class="k">elif</span> <span class="n">f_idx</span> <span class="o">&gt;=</span> <span class="n">min_len_for_trim</span><span class="p">:</span>  <span class="c1"># Trim only the end</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">r_idx</span><span class="p">]]</span>

        <span class="c1"># Trim both ends if possible; else don&#39;t trim</span>
        <span class="k">if</span> <span class="n">f_idx</span> <span class="o">&lt;</span> <span class="n">r_idx</span> <span class="ow">and</span> <span class="n">r_idx</span> <span class="o">-</span> <span class="n">f_idx</span> <span class="o">&gt;=</span> <span class="n">min_len_for_trim</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">f_idx</span><span class="p">:</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">f_idx</span><span class="p">:</span><span class="n">r_idx</span><span class="p">]]</span>

    <span class="c1"># Use the endpoints of the trimmed (or not trimmed) pixel coordinates to</span>
    <span class="c1"># compute direction vector</span>
    <span class="n">link_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">if</span> <span class="n">normalized</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">link_vec</span> <span class="o">=</span> <span class="n">link_vec</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">link_vec</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">link_vec</span></div>


<div class="viewcode-block" id="set_by_known_flow_directions"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.set_by_known_flow_directions">[docs]</a><span class="k">def</span> <span class="nf">set_by_known_flow_directions</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span> <span class="n">angthresh</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">lenthresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknown_thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">alg</span><span class="o">=</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;known_fdr&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets unknown link directions by determining which flow direction through</span>
<span class="sd">    the link minimizes the overall change in flow direction at the connecting</span>
<span class="sd">    nodes. For a set of links connected to a node, at least one of the links&#39;</span>
<span class="sd">    directions must be known for this algorithm to be effective. Links are</span>
<span class="sd">    set from longest to shortest, as longer links generally have less</span>
<span class="sd">    uncertainty associated with their directions.</span>

<span class="sd">    A number of thresholds are provided as options to control the power of</span>
<span class="sd">    the algorithm. This function should generally be applied iteratively,</span>
<span class="sd">    beginning with the most restrictive thresholds and gradually relaxing</span>
<span class="sd">    them.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    imshape : tuple</span>
<span class="sd">        Shape of the binary mask as (nrows, ncols).</span>
<span class="sd">    angthresh : float, optional</span>
<span class="sd">        Angle in radians to determine if an unknown link is parallel enough to</span>
<span class="sd">        its connected known links to set its direction. The default is 2.</span>
<span class="sd">    lenthresh : int, optional</span>
<span class="sd">        Length in pixels of the minimum link length required to use this</span>
<span class="sd">        algorithm to set its directionality. The default is 0.</span>
<span class="sd">    nknown_thresh : int, optional</span>
<span class="sd">        Number of known connected links required to use this algorithm to</span>
<span class="sd">        set the unknown link&#39;s directionality. The default is 1.</span>
<span class="sd">    alg : float, optional</span>
<span class="sd">        Algorithm ID to assign to the set link. The default is 6.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_candidates</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">lenthresh</span><span class="p">,</span> <span class="n">nknown_thresh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns unknown links that have at least one known connected link</span>
<span class="sd">        for setting by its direction.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">unknown_links</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_links</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">dolinks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_known</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">unknown_links</span><span class="p">:</span>

            <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span>

            <span class="c1"># Check both endos of the link; if for either the link in question</span>
            <span class="c1"># is the only unknown link; it is a candidate</span>
            <span class="n">nknown</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">conn_links</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nid</span><span class="p">)]</span>
                <span class="n">nknown</span> <span class="o">=</span> <span class="n">nknown</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conn_links</span> <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">nknown</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dolinks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
                <span class="n">n_known</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nknown</span><span class="p">)</span>

        <span class="c1"># Ensure there are any candidate links</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dolinks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Get link lengths</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dl</span><span class="p">)]</span> <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">dolinks</span><span class="p">]</span>
        <span class="c1"># Get link lengths in pixels</span>
        <span class="n">lengths_pix</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_pix&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dl</span><span class="p">)])</span> <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">dolinks</span><span class="p">]</span>

        <span class="c1"># Sort all dolinks by number of known connected links (max to min)</span>
        <span class="n">forsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dolinks</span><span class="p">,</span> <span class="n">n_known</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">lengths_pix</span><span class="p">]))</span>

        <span class="c1"># Apply nknown threshold</span>
        <span class="n">forsort</span> <span class="o">=</span> <span class="n">forsort</span><span class="p">[</span><span class="n">forsort</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">nknown_thresh</span><span class="p">]</span>

        <span class="c1"># Apply (pixel) length threshold</span>
        <span class="n">forsort</span> <span class="o">=</span> <span class="n">forsort</span><span class="p">[</span><span class="n">forsort</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lenthresh</span><span class="p">]</span>

        <span class="c1"># Do the sorting</span>
        <span class="n">forsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">forsort</span><span class="p">[</span><span class="n">forsort</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()])</span>

        <span class="c1"># Now sort dolinks from longer to shorter</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">forsort</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))))</span>
        <span class="n">dolinks_sorted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
            <span class="n">tosort</span> <span class="o">=</span> <span class="n">forsort</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">forsort</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">tosort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">tosort</span><span class="p">[</span><span class="n">tosort</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()])</span>
            <span class="n">dolinks_sorted</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tosort</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Convert to int</span>
        <span class="n">dolinks_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dls</span><span class="p">)</span> <span class="k">for</span> <span class="n">dls</span> <span class="ow">in</span> <span class="n">dolinks_sorted</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dolinks_sorted</span>

    <span class="n">dolinks</span> <span class="o">=</span> <span class="n">get_candidates</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">lenthresh</span><span class="p">,</span> <span class="n">nknown_thresh</span><span class="p">)</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">dolinks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="c1"># Get the first unknown link to set</span>
        <span class="n">dolink</span> <span class="o">=</span> <span class="n">dolinks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dolink</span><span class="p">)</span>

        <span class="c1"># In case the link was set by continuity</span>
        <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">nconn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span>

        <span class="n">ang_guess</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">us_node_guess</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nconn</span><span class="p">:</span>

            <span class="c1"># Ensure unknown link flows from node</span>
            <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)]:</span>
                <span class="n">lnu</span><span class="o">.</span><span class="n">flip_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">dolink</span><span class="p">)</span>

            <span class="n">ul_vec</span> <span class="o">=</span> <span class="n">get_link_vector</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">dolink</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>

            <span class="n">lconn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

            <span class="c1"># Find the connected links that are known</span>
            <span class="n">known_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lconn</span> <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Determine which set links are into/out of the node</span>
            <span class="n">in_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">out_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">known_links</span><span class="p">:</span>
                <span class="n">lidxt</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">lidxt</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">out_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">in_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>

            <span class="c1"># Compute the vectors for into-and out-of link. If there are</span>
            <span class="c1"># multiple vectors, their average is used.</span>
            <span class="n">in_dvec</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">out_dvec</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_links</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">in_dvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">in_links</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_links</span><span class="p">):</span>
                    <span class="n">in_dvec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_link_vector</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>
                <span class="n">in_dvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">in_dvec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_links</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out_dvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">out_links</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_links</span><span class="p">):</span>
                    <span class="n">out_dvec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">get_link_vector</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">ol</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>
                <span class="n">out_dvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out_dvec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Try both orientations of unknown link and compute the angles between</span>
            <span class="c1"># it and the known nodes</span>
            <span class="n">in_angs</span><span class="p">,</span> <span class="n">out_angs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># 1 is into node, -1 is out of node</span>
                <span class="n">ul_vec</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">ul_vec</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_dvec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">in_angs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">([</span><span class="n">in_dvec</span><span class="p">,</span><span class="n">ul_vec</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">in_dvec</span><span class="p">,</span><span class="n">ul_vec</span><span class="p">))))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_dvec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out_angs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">([</span><span class="n">out_dvec</span><span class="p">,</span><span class="n">ul_vec</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">out_dvec</span><span class="p">,</span><span class="n">ul_vec</span><span class="p">))))</span>

            <span class="c1"># &quot;Most parallel&quot; known link is that with the smallest interior angle</span>
            <span class="c1"># Smallest interior angle is determined as min of both orientations of unknown link</span>
            <span class="n">in_flip</span><span class="p">,</span> <span class="n">out_flip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_angs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">in_par_angle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">in_angs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">in_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">in_angs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">in_flip</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">in_par_angle</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_angs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out_par_angle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">out_angs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">out_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">out_angs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">out_flip</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_par_angle</span> <span class="o">=</span> <span class="mi">100</span>

            <span class="c1"># Determine us node based on most-parallel known link</span>
            <span class="c1"># Need to know if the minimum angle came from the flipped orientation of the unknown link to set direction</span>
            <span class="k">if</span> <span class="n">out_par_angle</span> <span class="o">&lt;</span> <span class="n">in_par_angle</span><span class="p">:</span>
                <span class="n">ang_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_par_angle</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">out_flip</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">usng</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nconn</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">n</span><span class="p">])</span>
                    <span class="n">us_node_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">usng</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">us_node_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Unknown link flows into node</span>
                <span class="n">ang_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_par_angle</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">in_flip</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">us_node_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">usng</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nconn</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">n</span><span class="p">])</span>
                    <span class="n">us_node_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">usng</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

        <span class="c1"># Set link based on best guess from all known connected links</span>
        <span class="n">min_ang</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ang_guess</span><span class="p">)</span>
        <span class="c1"># Ensure threshold is met</span>
        <span class="k">if</span> <span class="n">min_ang</span> <span class="o">&lt;</span> <span class="n">angthresh</span><span class="p">:</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">us_node_guess</span><span class="p">[</span><span class="n">ang_guess</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">min_ang</span><span class="p">)]</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">lidx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span>
                                    <span class="n">alg</span> <span class="o">=</span> <span class="n">alg</span><span class="p">,</span> <span class="n">checkcontinuity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>

<span class="sd">&quot;&quot;&quot; Functions below here are deprecated or unused, but might be useful later &quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot; No testing performed &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">set_no_backtrack</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">nconn</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]):</span>

        <span class="k">if</span> <span class="n">cert</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">nconn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">nconn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="n">uslinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nconn</span><span class="p">[</span><span class="mi">0</span><span class="p">])][:]</span>
        <span class="n">uslinks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">dslinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nconn</span><span class="p">[</span><span class="mi">1</span><span class="p">])][:]</span>
        <span class="n">dslinks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>

        <span class="n">us_certains</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">uslinks</span> <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ds_certains</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dslinks</span> <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">us_certains</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uslinks</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_certains</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dslinks</span><span class="p">):</span>
            <span class="n">startnode</span> <span class="o">=</span> <span class="n">nconn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">removelink</span> <span class="o">=</span> <span class="n">lid</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_shortest_no_backtrack</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">startnode</span><span class="p">,</span> <span class="n">removelink</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_certains</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dslinks</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">us_certains</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uslinks</span><span class="p">):</span>
            <span class="n">startnode</span> <span class="o">=</span> <span class="n">nconn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">removelink</span> <span class="o">=</span> <span class="n">lid</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_shortest_no_backtrack</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">startnode</span><span class="p">,</span> <span class="n">removelink</span><span class="p">,</span> <span class="s1">&#39;us&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span>


<span class="k">def</span> <span class="nf">set_shortest_no_backtrack</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">startnode</span><span class="p">,</span> <span class="n">removelink</span><span class="p">,</span> <span class="n">usds</span><span class="p">):</span>

    <span class="n">alg</span> <span class="o">=</span> <span class="mi">25</span>

    <span class="c1"># Create networkX graph, adding weighted edges</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">wt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">wt</span><span class="p">)</span>

    <span class="c1"># Remove the immediately upstream (or downstream) known link so flow cannot</span>
    <span class="c1"># travel the wrong direction</span>
    <span class="n">rem_edge</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">removelink</span><span class="p">)]</span>
    <span class="n">G</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">rem_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rem_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Find the endnode to travel to</span>
    <span class="k">if</span> <span class="n">usds</span> <span class="o">==</span> <span class="s1">&#39;ds&#39;</span><span class="p">:</span>
        <span class="n">endpoints</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">endpoints</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">endnode</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">len_to_ep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
            <span class="n">len_to_ep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path_length</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">startnode</span><span class="p">,</span> <span class="n">ep</span><span class="p">))</span>
        <span class="n">endnode</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="n">len_to_ep</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">len_to_ep</span><span class="p">))]</span>

    <span class="c1"># Get shortest path nodes</span>
    <span class="n">pathnodes</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dijkstra_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">startnode</span><span class="p">,</span> <span class="n">endnode</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>

    <span class="c1"># Convert to link-to-link path</span>
    <span class="n">pathlinks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pathnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pathnodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">ulinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span>
        <span class="n">vlinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
        <span class="n">pathlinks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ul</span> <span class="k">for</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">ulinks</span> <span class="k">if</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">vlinks</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Set the directionality of each of the links</span>
    <span class="k">if</span> <span class="n">usds</span> <span class="o">==</span> <span class="s1">&#39;ds&#39;</span><span class="p">:</span>
        <span class="n">pathnodes</span> <span class="o">=</span> <span class="n">pathnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pathnodes</span> <span class="o">=</span> <span class="n">pathnodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">for</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">pl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pathnodes</span><span class="p">,</span> <span class="n">pathlinks</span><span class="p">):</span>
        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span> <span class="o">=</span> <span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span>


<div class="viewcode-block" id="set_artificial_nodes"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.directionality.set_artificial_nodes">[docs]</a><span class="k">def</span> <span class="nf">set_artificial_nodes</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">checknodes</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is deprecated as of v0.3 and is no longer called.</span>

<span class="sd">    Set the directionality of links where aritificial nodes were added. For such</span>
<span class="sd">    loops, flow will travel the same way through both sides of the loop (to avoid</span>
<span class="sd">    cycles). Therefore, if one side is known, we can set the other side.</span>
<span class="sd">    Method 1 sets a broken link if its counterpart is known.</span>
<span class="sd">    Method 2 sets a side of the loop if the other side is known.</span>
<span class="sd">    Method 3 sets both sides if the input to one of the end nodes is known.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    checknodes : int or str, optional</span>
<span class="sd">        Node ids to check for presence of settable artificial links. If &#39;all&#39;,</span>
<span class="sd">        all nodes in the network are checked.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties updated to set directionality</span>
<span class="sd">        according to this algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">alg</span> <span class="o">=</span> <span class="mf">2.1</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">checknodes</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="c1"># Determine if we&#39;re at a head node of an artificial loop</span>
        <span class="n">nidx</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">linkconn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nidx</span><span class="p">][:]</span>
        <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">linkconn</span><span class="p">:</span>
            <span class="n">nodecheck</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lc</span><span class="p">)][:]</span>
            <span class="n">nodecheck</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="c1"># If a neighboring node is an aritifical one, we&#39;re at a head node</span>
            <span class="k">if</span> <span class="n">nodecheck</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;arts&#39;</span><span class="p">]:</span>
                <span class="n">a_node</span> <span class="o">=</span> <span class="n">nodecheck</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If there is no artificial node, move to next</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a_node</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Ensure the non-artificial links are known and all flow either into</span>
        <span class="c1"># or out of nead node</span>
        <span class="n">artlinks</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;arts&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;arts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a_node</span><span class="p">)]</span>
        <span class="n">nonartlinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">linkconn</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">artlinks</span><span class="p">]</span>

        <span class="c1"># Ensure nonartificial links are known</span>
        <span class="n">certs</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nal</span><span class="p">)]</span> <span class="k">for</span> <span class="n">nal</span> <span class="ow">in</span> <span class="n">nonartlinks</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">certs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">certs</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Check that non-artificial links are same directionality wrt head node</span>
        <span class="n">firstidcs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nal</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">nal</span> <span class="ow">in</span> <span class="n">nonartlinks</span><span class="p">])</span>
        <span class="n">lastidcs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nal</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">nal</span> <span class="ow">in</span> <span class="n">nonartlinks</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstidcs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">firstidcs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nidx</span><span class="p">]:</span><span class="c1"># Links are leaving head node</span>
            <span class="n">inout</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lastidcs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">lastidcs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nidx</span><span class="p">]:</span>
            <span class="n">inout</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Determine the short links of the artificial link triad</span>
        <span class="n">shortlinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a_node</span><span class="p">)][:]</span>
        <span class="n">endnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">shortlinks</span><span class="p">:</span>
            <span class="n">forappend</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sl</span><span class="p">)][:]</span>
            <span class="n">forappend</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a_node</span><span class="p">)</span>
            <span class="n">endnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">forappend</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Find corresponding long link of the triad</span>
        <span class="n">posslinks</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">posslinks</span><span class="p">:</span>
            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">endnodes</span><span class="p">):</span>
                <span class="n">longlink</span> <span class="o">=</span> <span class="n">p</span>

        <span class="c1"># Set the longlink</span>
        <span class="n">ll_idx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">longlink</span><span class="p">)</span>
        <span class="n">ll_conn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">ll_idx</span><span class="p">][:]</span>
        <span class="k">if</span> <span class="n">inout</span> <span class="o">==</span> <span class="s1">&#39;out&#39;</span><span class="p">:</span>
            <span class="n">ll_conn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">ll_conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">inout</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">ll_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">ll_idx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span> <span class="n">checkcontinuity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Set short link that shares a node with longlink and link_into</span>
        <span class="c1"># The final shortlink of the triad will be set by continuity</span>
        <span class="n">shortlink</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">shortlinks</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">shortlink</span><span class="p">)</span>
        <span class="n">sl_conn</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">slidx</span><span class="p">][:]</span>
        <span class="k">if</span> <span class="n">inout</span> <span class="o">==</span> <span class="s1">&#39;out&#39;</span><span class="p">:</span>
            <span class="n">sl_conn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">sl_conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">inout</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">slidx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">slidx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">)</span>

        <span class="c1"># Now check continuity at all the artificial nodes</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">checknodes</span><span class="o">=</span><span class="n">endnodes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, J. Schwenk &amp; J. Hariharan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>