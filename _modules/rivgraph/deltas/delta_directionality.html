<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rivgraph.deltas.delta_directionality &mdash; RivGraph 0.4 documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html"><img src="../../../_static/rg_logo_full.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../background/index.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/index.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maskmaking/index.html">Maskmaking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../shoreline/index.html">Shoreline creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linksnodes/index.html">Link and Node Dictionaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../issues/index.html">Known issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../featuredevelopment/index.html">Feature Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apiref/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">RivGraph</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>rivgraph.deltas.delta_directionality</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rivgraph.deltas.delta_directionality</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">delta_directionality</span>
<span class="sd">====================</span>

<span class="sd">Created on Sun Nov 18 19:26:01 2018</span>

<span class="sd">@author: Jon</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">mode</span><span class="p">,</span> <span class="n">linregress</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">ConvexHull</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.morphology</span> <span class="kn">import</span> <span class="n">distance_transform_edt</span>
<span class="kn">import</span> <span class="nn">rivgraph.io_utils</span> <span class="k">as</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">rivgraph.directionality</span> <span class="k">as</span> <span class="nn">dy</span>

<span class="c1"># Todo: create the manual fix csv no matter what; allow user to input values</span>
<span class="c1"># before running directionality.</span>


<div class="viewcode-block" id="set_link_directions"><a class="viewcode-back" href="../../../apiref/deltas.html#rivgraph.deltas.delta_directionality.set_link_directions">[docs]</a><span class="k">def</span> <span class="nf">set_link_directions</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span> <span class="n">manual_set_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set each link direction in a network.</span>

<span class="sd">    This function sets the direction of each link within the network. It</span>
<span class="sd">    calls a number of helping functions and uses a somewhat-complicated logic</span>
<span class="sd">    to achieve this. The algorithms and logic is described in this open-access</span>
<span class="sd">    paper: https://esurf.copernicus.org/articles/8/87/2020/esurf-8-87-2020.pdf</span>

<span class="sd">    Every time this is run, all directionality information is reset and</span>
<span class="sd">    recomputed. This includes checking for manually set links via the provided</span>
<span class="sd">    csv.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    imshape : tuple</span>
<span class="sd">        Shape of binary mask as (nrows, ncols).</span>
<span class="sd">    manual_set_csv : str, optional</span>
<span class="sd">        Path to a user-provided csv file of known link directions. The default</span>
<span class="sd">        is None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties with all directions set.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties with all directions set.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add fields to links dict for tracking and setting directionality</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">add_directionality_trackers</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">)</span>

    <span class="c1"># If a manual fix csv has been provided, set those links first</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">dir_set_manually</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">manual_set_csv</span><span class="p">)</span>

    <span class="c1"># Initial attempt to set directions</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">set_initial_directionality</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>

    <span class="c1"># At this point, all links have been set. Check for nodes that violate</span>
    <span class="c1"># continuity</span>
    <span class="n">cont_violators</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">check_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="c1"># Attempt to fix any sources or sinks within the network</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont_violators</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">fix_sources_and_sinks</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="c1"># Check that continuity problems are resolved</span>
    <span class="n">cont_violators</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">check_continuity</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont_violators</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Nodes </span><span class="si">{}</span><span class="s1"> violate continuity. Check connected links and fix manually.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cont_violators</span><span class="p">))</span>

    <span class="c1"># Attempt to fix any cycles in the network (reports unfixable within function)</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">allcyclesfixed</span> <span class="o">=</span> <span class="n">fix_delta_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>

    <span class="c1"># The following is done automatically now, regardless of if cycles or sinks exist</span>
    <span class="c1"># # Create a csv to store manual edits to directionality if does not exist</span>
    <span class="c1"># if os.path.isfile(manual_set_csv) is False:</span>
    <span class="c1">#     if len(cont_violators) &gt; 0 or allcyclesfixed == 0:</span>
    <span class="c1">#         io.create_manual_dir_csv(manual_set_csv)</span>
    <span class="c1">#         print(&#39;A .csv file for manual fixes to link directions at {}.&#39;.format(manual_set_csv))</span>

    <span class="k">if</span> <span class="n">allcyclesfixed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No cycles were found in network.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="set_initial_directionality"><a class="viewcode-back" href="../../../apiref/deltas.html#rivgraph.deltas.delta_directionality.set_initial_directionality">[docs]</a><span class="k">def</span> <span class="nf">set_initial_directionality</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make initial attempt to set flow directions.</span>

<span class="sd">    Makes an initial attempt to set all flow directions within the network.</span>
<span class="sd">    This represents the core of the &quot;delta recipe&quot; described in the following</span>
<span class="sd">    open access paper:</span>
<span class="sd">    https://esurf.copernicus.org/articles/8/87/2020/esurf-8-87-2020.pdf</span>
<span class="sd">    However, note that as RivGraph develops, this recipe may no longer match</span>
<span class="sd">    the one presented in that paper. The recipe chains together a number of</span>
<span class="sd">    exploitative algorithms to iteratively set flow directions for the most</span>
<span class="sd">    certain links first.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    imshape : tuple</span>
<span class="sd">        Shape of binary mask as (nrows, ncols).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties with initial directions set.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties with initial directions set.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute all the &quot;guesses&quot;</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">dir_main_channel</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dir_synthetic_DEM</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">dir_shortest_paths_nodes</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">dir_shortest_paths_links</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">dir_bridges</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="c1"># Set link directions</span>
    <span class="c1"># First, set inlet/outlet directions as they are always 100% accurate</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_inletoutlet</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="c1"># Use bridges to set links as they are always 100% accurate</span>
    <span class="c1"># alg = 5</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;bridges&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">idcs</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lga</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]):</span>
        <span class="c1"># Only need to set links that haven&#39;t been set</span>
        <span class="k">if</span> <span class="n">cert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="c1"># Set all the links that are known from bridge links</span>
        <span class="k">if</span> <span class="n">alg</span> <span class="ow">in</span> <span class="n">lga</span><span class="p">:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span>
                                       <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">alg</span><span class="p">)],</span> <span class="n">alg</span><span class="p">)</span>

    <span class="c1"># Use main channels (4) to set links</span>
    <span class="c1"># alg = 4</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;main_chans&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">idcs</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lga</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]):</span>
        <span class="c1"># Only need to set links that haven&#39;t been set</span>
        <span class="k">if</span> <span class="n">cert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="c1"># Set all the links that are known from main_channel</span>
        <span class="k">if</span> <span class="n">alg</span> <span class="ow">in</span> <span class="n">lga</span><span class="p">:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span>
                                       <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">alg</span><span class="p">)],</span> <span class="n">alg</span><span class="p">)</span>

    <span class="c1"># Set the longest, steepest links according to io_surface</span>
    <span class="c1"># (these are those we are most certain of)</span>
    <span class="c1"># alg = 13</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;longest_steepest&#39;</span><span class="p">)</span>
    <span class="n">len75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;len_adj&#39;</span><span class="p">],</span> <span class="mi">75</span><span class="p">)</span>
    <span class="n">slope50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]),</span> <span class="mi">50</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">llen</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lga</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">lslope</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;len_adj&#39;</span><span class="p">],</span>
                                                <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">],</span>
                                                <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">],</span>
                                                <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">],</span>
                                                <span class="n">links</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">cert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">llen</span> <span class="o">&gt;</span> <span class="n">len75</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lslope</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">slope50</span><span class="p">:</span>
            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lga</span><span class="p">:</span>
                <span class="n">usnode</span> <span class="o">=</span> <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">))]</span>
                <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span><span class="p">)</span>

    <span class="c1"># Set the most certain angles</span>
    <span class="n">angthreshs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angthreshs</span><span class="p">:</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_by_known_flow_directions</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span>
                                                       <span class="n">angthresh</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>

    <span class="c1"># Set using direction of nearest main channel</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_by_nearest_main_channel</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span>
                                                  <span class="n">nodethresh</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Set the most certain angles</span>
    <span class="n">angthreshs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angthreshs</span><span class="p">:</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_by_known_flow_directions</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span>
                                                       <span class="n">angthresh</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>

    <span class="c1"># Set using direction of nearest main channel</span>
    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_by_nearest_main_channel</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span>
                                                  <span class="n">nodethresh</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">angthreshs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angthreshs</span><span class="p">:</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_by_known_flow_directions</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span>
                                                       <span class="n">angthresh</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                                                       <span class="n">lenthresh</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Use io_surface (3) to set links that are longer</span>
    <span class="c1"># than the median link length</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">)</span>
    <span class="n">medlinklen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">llen</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lga</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">cert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">llen</span> <span class="o">&gt;</span> <span class="n">medlinklen</span> <span class="ow">and</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lga</span><span class="p">:</span>
            <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">))]</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span><span class="p">)</span>

    <span class="c1"># Set again by angles, but reduce the lenthresh</span>
    <span class="c1"># (shorter links will be set that were not previously)</span>
    <span class="n">angthreshs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angthreshs</span><span class="p">:</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_by_known_flow_directions</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span>
                                                       <span class="n">angthresh</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                                                       <span class="n">lenthresh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># If any three methods agree, set that link to whatever they agree on</span>
    <span class="c1"># alg = 15</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;three_agree&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">idcs</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lga</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]):</span>
        <span class="c1"># Only need to set links that haven&#39;t been set</span>
        <span class="k">if</span> <span class="n">cert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="c1"># Set all the links with 3 or more guesses that agree</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">lg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alg</span><span class="p">)</span>

    <span class="c1"># Set again by angles, but reduce the lenthresh</span>
    <span class="c1"># (shorter links will be set that were not previously)</span>
    <span class="n">angthreshs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angthreshs</span><span class="p">:</span>
        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_by_known_flow_directions</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">,</span>
                                                       <span class="n">angthresh</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                                                       <span class="n">lenthresh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># If artificial DEM and at least one shortest path method agree,</span>
    <span class="c1"># set link to be their agreement</span>
    <span class="c1"># alg = 16</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem_and_sp&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">idcs</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lga</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">],</span>
                                        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">]):</span>
        <span class="c1"># Only need to set links that haven&#39;t been set</span>
        <span class="k">if</span> <span class="n">cert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="c1"># Set all the links with 2 or more same guesses that are not</span>
        <span class="c1"># shortest path (one may be shortest path)</span>
        <span class="k">if</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lga</span> <span class="ow">and</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;sp_links&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lga</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">))]</span> <span class="o">==</span> <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;sp_links&#39;</span><span class="p">))]:</span>
                <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span>
                                           <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">))],</span>
                                           <span class="n">alg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lga</span> <span class="ow">and</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;sp_nodes&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lga</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">))]</span> <span class="o">==</span> <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;sp_nodes&#39;</span><span class="p">))]:</span>
                <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span>
                                           <span class="n">lg</span><span class="p">[</span><span class="n">lga</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">))],</span>
                                           <span class="n">alg</span><span class="p">)</span>

    <span class="c1"># Find remaining uncertain links</span>
    <span class="n">uncertain</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">lc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Set remaining uncertains according to io_surface (3)</span>
    <span class="c1"># alg = 10 # change this one!</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">uncertain</span><span class="p">:</span>
        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alg</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]:</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">alg</span><span class="p">)]</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_link</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">linkidx</span><span class="p">,</span> <span class="n">usnode</span><span class="p">,</span> <span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="fix_delta_cycles"><a class="viewcode-back" href="../../../apiref/deltas.html#rivgraph.deltas.delta_directionality.fix_delta_cycles">[docs]</a><span class="k">def</span> <span class="nf">fix_delta_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to resolve cycles within the network.</span>

<span class="sd">    Attempts to resolve all cycles within the delta network. This function</span>
<span class="sd">    is essentially a wrapper for :func:`fix_delta_cycle`, which is where the</span>
<span class="sd">    heavy lifting is actually done. This function finds cycles, calls</span>
<span class="sd">    :func:`fix_delta_cycle` on each one, then aggregates the results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    imshape : tuple</span>
<span class="sd">        Shape of binary mask as (nrows, ncols).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties with all possible cycles fixed.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties with all possible cycles fixed.</span>
<span class="sd">    allfixed : bool</span>
<span class="sd">        True if all cycles were resolved, else False.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Tracks if all cycles were fixed</span>
    <span class="n">allfixed</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Create networkx graph object</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">]:</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Check for cycles</span>
    <span class="n">cantfix_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fixed_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_directed_acyclic_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># Get list of cycles to fix</span>
        <span class="n">c_nodes</span><span class="p">,</span> <span class="n">c_links</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">get_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Combine all cycles that share links</span>
        <span class="n">c_links</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">merge_list_of_lists</span><span class="p">(</span><span class="n">c_links</span><span class="p">)</span>

        <span class="c1"># Fix the cycles</span>
        <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">cfix_links</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_links</span><span class="p">):</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">fixed</span> <span class="o">=</span> <span class="n">fix_delta_cycle</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">cfix_links</span><span class="p">,</span>
                                                  <span class="n">imshape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fixed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cantfix_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fixed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fixed_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cantfix_links</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">allfixed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not fix the following cycles (links): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">c_links</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cantfix_links</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_links</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">allfixed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The following cycles (links) were fixed, but should be manually checked: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">c_links</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fixed_links</span><span class="p">]))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">allfixed</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Indicates there were no cycles to fix</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">allfixed</span></div>


<div class="viewcode-block" id="fix_delta_cycle"><a class="viewcode-back" href="../../../apiref/deltas.html#rivgraph.deltas.delta_directionality.fix_delta_cycle">[docs]</a><span class="k">def</span> <span class="nf">fix_delta_cycle</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">cyc_links</span><span class="p">,</span> <span class="n">imshape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to resolve a single cycle.</span>

<span class="sd">    Attempts to resolve a single cycle within a delta network. The general</span>
<span class="sd">    logic is that all link directions of the cycle are un-set except for those</span>
<span class="sd">    set by highly-reliable algorithms, and a modified direction-setting</span>
<span class="sd">    recipe is implemented to re-set these algorithms. This was developed</span>
<span class="sd">    according to the most commonly-encountered cases for real deltas, but could</span>
<span class="sd">    certainly be improved.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    cyc_links : list</span>
<span class="sd">        Link ids comprising the cycle to fix.</span>
<span class="sd">    imshape : tuple</span>
<span class="sd">        Shape of binary mask as (nrows, ncols).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties with cycle fixed, if possible.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties with cycle fixed, if possible.</span>
<span class="sd">    fixed : bool</span>
<span class="sd">        True if the cycle was resolved, else False.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">re_set_linkdirs</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">):</span>
        <span class="c1"># Cycle links are attempted to be reset according to algorithms here.</span>
        <span class="n">angthreshs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angthreshs</span><span class="p">:</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">set_by_known_flow_directions</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span>
                                                           <span class="n">imshape</span><span class="p">,</span>
                                                           <span class="n">angthresh</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                                                           <span class="n">lenthresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                           <span class="n">alg</span><span class="o">=</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;known_fdr_rs&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span>

    <span class="c1"># Track if fix was successful (1:yes, 0:no)</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># List of algorithm ids that should not be reset if previously used to</span>
    <span class="c1"># determine direction</span>
    <span class="c1"># dont_reset_algs = [-1, 0, 4, 5, 13]</span>
    <span class="n">dont_reset_algs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;manual_set&#39;</span><span class="p">,</span> <span class="s1">&#39;inletoutlet&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;main_chans&#39;</span><span class="p">,</span> <span class="s1">&#39;bridges&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;longest_steepest&#39;</span><span class="p">]]</span>

    <span class="c1"># Simplest method: unset the cycle links and reset them according to angles</span>
    <span class="c1"># Get resettale links</span>
    <span class="n">toreset</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cyc_links</span> <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dont_reset_algs</span><span class="p">]</span>

    <span class="c1"># Get original link orientations in case fix does not work</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">cycle_get_original_orientation</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">toreset</span><span class="p">)</span>

    <span class="c1"># Set certainty of cycle links to zero</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">toreset</span><span class="p">:</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tr</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">re_set_linkdirs</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>

    <span class="c1"># Check that all links were reset</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">toreset</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">toreset</span><span class="p">):</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Check that cycle was resolved</span>
    <span class="n">cyclenode</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">toreset</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cyc_n</span><span class="p">,</span> <span class="n">cyc_l</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">get_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">checknode</span><span class="o">=</span><span class="n">cyclenode</span><span class="p">)</span>

    <span class="c1"># If the cycle was not fixed, try again, but set the cycle links AND the</span>
    <span class="c1"># links connected to the cycle to unknown</span>
    <span class="k">if</span> <span class="n">cyc_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cyclenode</span> <span class="ow">in</span> <span class="n">cyc_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># First return to original orientation</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">cycle_return_to_original_orientation</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span>

        <span class="c1"># Get all cycle links and those connected to cycle</span>
        <span class="n">toreset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">cyc_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cn</span><span class="p">)]</span>
            <span class="n">toreset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">toreset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">toreset</span><span class="p">)</span>

        <span class="c1"># Save original orientation in case cycle cannot be fixed</span>
        <span class="n">orig_links</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">cycle_get_original_orientation</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">toreset</span><span class="p">)</span>

        <span class="c1"># Un-set the cycle+connected links</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">toreset</span><span class="p">:</span>
            <span class="n">lidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain_alg&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dont_reset_algs</span><span class="p">:</span>
                <span class="n">links</span><span class="p">[</span><span class="s1">&#39;certain&#39;</span><span class="p">][</span><span class="n">lidx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">re_set_linkdirs</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>

        <span class="c1"># See if the fix resolved the cycle - if not, reset to original</span>
        <span class="n">cyc_n</span><span class="p">,</span> <span class="n">cyc_l</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">get_cycles</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">checknode</span><span class="o">=</span><span class="n">cyclenode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cyc_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cyclenode</span> <span class="ow">in</span> <span class="n">cyc_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">cycle_return_to_original_orientation</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">orig_links</span><span class="p">)</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">fixed</span></div>


<div class="viewcode-block" id="hull_coords"><a class="viewcode-back" href="../../../apiref/deltas.html#rivgraph.deltas.delta_directionality.hull_coords">[docs]</a><span class="k">def</span> <span class="nf">hull_coords</span><span class="p">(</span><span class="n">xy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute convex hull of a set of input points.</span>

<span class="sd">    Computes the convex hull of a set of input points. Arranges the convex</span>
<span class="sd">    hull coordinates in a clockwise manner and removes the longest edge.</span>
<span class="sd">    This function is required by :func:`dir_synthetic_dem`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xy : np.array</span>
<span class="sd">        Two element array. First element contains x coordinates, second</span>
<span class="sd">        contains y coordinates of points to compute a convex hull around.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hull_coords : np.array</span>
<span class="sd">        Nx2 array of coordinates defining the convex hull of the input points.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find the convex hull of a set of coordinates, then order them clockwisely</span>
    <span class="c1"># and remove the longest edge</span>
    <span class="n">hull_verts</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span><span class="o">.</span><span class="n">vertices</span>
    <span class="n">hull_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">hull_verts</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">hull_verts</span><span class="p">])))</span>
    <span class="n">hull_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hull_coords</span><span class="p">,</span> <span class="p">[</span><span class="n">hull_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
                             <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">hull_coords</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Find the biggest gap between hull points</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">hull_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                     <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">hull_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">maxdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">first_part</span> <span class="o">=</span> <span class="n">hull_coords</span><span class="p">[</span><span class="n">maxdist</span><span class="p">:,</span> <span class="p">:]</span>
    <span class="n">second_part</span> <span class="o">=</span> <span class="n">hull_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">maxdist</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">first_part</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hull_coords</span> <span class="o">=</span> <span class="n">second_part</span>
    <span class="k">elif</span> <span class="n">second_part</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hull_coords</span> <span class="o">=</span> <span class="n">first_part</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hull_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">first_part</span><span class="p">,</span> <span class="n">second_part</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">hull_coords</span></div>


<div class="viewcode-block" id="dir_synthetic_DEM"><a class="viewcode-back" href="../../../apiref/deltas.html#rivgraph.deltas.delta_directionality.dir_synthetic_DEM">[docs]</a><span class="k">def</span> <span class="nf">dir_synthetic_DEM</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">imshape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a synthetic DEM using inlet/outlet locations.</span>

<span class="sd">    Builds a synthetic DEM by considering inlets as &quot;hills&quot; and outlets as</span>
<span class="sd">    &quot;depressions.&quot; This synthetic is then used to compute the &quot;slope&quot;</span>
<span class="sd">    of each link, which is added to the links dictionary. Additionally,</span>
<span class="sd">    direction guesses for each link&#39;s flow are computed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>
<span class="sd">    imshape : tuple</span>
<span class="sd">        Shape of binary mask as (nrows, ncols).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : dict</span>
<span class="sd">        Network links and associated properties including a &#39;slope&#39;.</span>
<span class="sd">    nodes : dict</span>
<span class="sd">        Network nodes and associated properties.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">algmap</span><span class="p">(</span><span class="s1">&#39;syn_dem&#39;</span><span class="p">)</span>

    <span class="c1"># Create empty image to store surface</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">imshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Get row,col coordinates of outlet nodes, arrange them in a</span>
    <span class="c1"># clockwise order</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">o</span><span class="p">)]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;outlets&#39;</span><span class="p">]]</span>
    <span class="n">outsxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outsxy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">hco</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">outsxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">outsxy</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hco</span> <span class="o">=</span> <span class="n">hull_coords</span><span class="p">(</span><span class="n">outsxy</span><span class="p">)</span>

    <span class="c1"># Burn the hull into the Iout surface</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hco</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">linterp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">hco</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">hco</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">xinterp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">hco</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hco</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mf">.1</span><span class="p">)</span>
        <span class="n">yinterp</span> <span class="o">=</span> <span class="n">linterp</span><span class="p">(</span><span class="n">xinterp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xinterp</span><span class="p">,</span> <span class="n">yinterp</span><span class="p">):</span>
            <span class="n">I</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">Iout</span> <span class="o">=</span> <span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="p">(</span><span class="n">Iout</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Iout</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Iout</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Iout</span><span class="p">))</span>

    <span class="c1"># Get coordinates of inlet nodes; use only the widest inlet and any#</span>
    <span class="c1"># inlets within 25% of its width</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]]</span>
    <span class="n">in_wids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;inlets&#39;</span><span class="p">]:</span>
        <span class="n">linkid</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">linkid</span><span class="p">)</span>
        <span class="n">in_wids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;wid_adj&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">])</span>
    <span class="n">maxwid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">in_wids</span><span class="p">)</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">iw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_wids</span><span class="p">)</span> <span class="k">if</span>
            <span class="nb">abs</span><span class="p">((</span><span class="n">iw</span> <span class="o">-</span> <span class="n">maxwid</span><span class="p">)</span><span class="o">/</span><span class="n">maxwid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">.25</span><span class="p">]</span>
    <span class="n">ins_wide_enough</span> <span class="o">=</span> <span class="p">[</span><span class="n">ins</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span>
    <span class="n">insxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">ins_wide_enough</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">insxy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">hci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">insxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">insxy</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hci</span> <span class="o">=</span> <span class="n">hull_coords</span><span class="p">(</span><span class="n">insxy</span><span class="p">)</span>

    <span class="c1"># Burn the hull into the Iout surface</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">imshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">hci</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">I</span><span class="p">[</span><span class="n">hci</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">hci</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hci</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">linterp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">hci</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">hci</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">xinterp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">hci</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hci</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mf">.1</span><span class="p">)</span>
            <span class="n">yinterp</span> <span class="o">=</span> <span class="n">linterp</span><span class="p">(</span><span class="n">xinterp</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xinterp</span><span class="p">,</span> <span class="n">yinterp</span><span class="p">):</span>
                <span class="n">I</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">Iin</span> <span class="o">=</span> <span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="n">Iin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Iin</span><span class="p">)</span> <span class="o">-</span> <span class="n">Iin</span>
    <span class="n">Iin</span> <span class="o">=</span> <span class="p">(</span><span class="n">Iin</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Iin</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Iin</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Iin</span><span class="p">))</span>

    <span class="c1"># Compute the final surface by adding the inlet and outlet images</span>
    <span class="n">Isurf</span> <span class="o">=</span> <span class="n">Iout</span> <span class="o">+</span> <span class="n">Iin</span>

    <span class="c1"># Guess the flow direction of each link</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>

        <span class="n">linkidx</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">lidcs</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">][:]</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">lidcs</span><span class="p">,</span> <span class="n">imshape</span><span class="p">)</span>

        <span class="n">dists_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">dists_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dists_temp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">elevs</span> <span class="o">=</span> <span class="n">Isurf</span><span class="p">[</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">linreg</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">dists_temp</span><span class="p">,</span> <span class="n">elevs</span><span class="p">)</span>

        <span class="c1"># Make sure slope is negative, else flip direction</span>
        <span class="k">if</span> <span class="n">linreg</span><span class="o">.</span><span class="n">slope</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lidcs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lidcs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># Store guess</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">usnode</span><span class="p">)</span>
        <span class="n">links</span><span class="p">[</span><span class="s1">&#39;guess_alg&#39;</span><span class="p">][</span><span class="n">linkidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>

        <span class="c1"># Store slope</span>
        <span class="n">slopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linreg</span><span class="o">.</span><span class="n">slope</span><span class="p">)</span>

    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slopes</span>

    <span class="k">return</span> <span class="n">links</span><span class="p">,</span> <span class="n">nodes</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, J. Schwenk &amp; J. Hariharan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>